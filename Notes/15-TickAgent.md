# Lec 15

TicketAgents:

1. é¡ºåºæ‰§è¡Œ
2. â€œçœ‹èµ·æ¥åŒæ—¶è¿è¡Œâ€
3. çº¿ç¨‹ä¹‹é—´å…±äº«èµ„æº
4. å¦‚ä½•è§£å†³çº¿ç¨‹é—´å…±äº«èµ„æºçš„é—®é¢˜

## Ticket Agents æ¨¡æ‹Ÿ

### 1. é¡ºåºæ‰§è¡Œçš„æ¨¡æ‹Ÿç¨‹åº

ä¸Šæ¬¡è¯¾ç¨‹ä¸­æåˆ°çš„æ¨¡æ‹Ÿèˆªç­å”®ç¥¨çš„ç¨‹åºï¼Œä¸ä¸Šæ¬¡çš„ç¨‹åºæœ‰å°‘è®¸å˜åŒ–

```c

void sellTickets(int agentid, int numTicketsToSell)
{
    while(numTicketsToSell > 0)
    {
        printf("Agent%d sells a ticket\n", agentNo);
        numTicketsToSell--;
    }
    
    printf("Agent%d: All done!\n", agentNo);
}


int main()
{
    int numAgents = 10; 
    int numTickets = 150; 
    
 
    for(int agent = 1; agent <= numAgents; agent++)
    {
        sellTickets(agent, numTickets/numAgents);
    }
    
  
    return 0; // returns 0 to satisfied compiler 
}
```

ä¸ºä»€ä¹ˆè¿™ä¸ªç¨‹åºä¸èƒ½å¾ˆå¥½çš„æ¨¡æ‹Ÿç°å®ç”Ÿæ´»ï¼Ÿ

å› ä¸ºè¿™ä¸ªç¨‹åºæ˜¯é¡ºåºæ‰§è¡Œçš„ï¼Œè€Œåœ¨å®é™…ç”Ÿæ´»ä¸­åœ¨å”®ç¥¨å¤„2æœ‰ä»»ä½•åŠ¨ä½œä¹‹å‰ï¼Œå”®ç¥¨å¤„1æœ‰å¯èƒ½ä¼šå–å®Œæ‰€æœ‰çš„15å¼ ç¥¨ã€‚æŒ‰ç…§æ¨¡æ‹Ÿç¨‹åºçš„é€»è¾‘ï¼Œæ¯ä¸ªagent ä¼šæœ‰16è¡Œæ‰“å°ï¼Œå¹¶ä¸”æŒ‰ç…§agentidå‡åºæ’åˆ—ã€‚

å®é™…ç”Ÿæ´»ä¸­æ‰€æœ‰çš„15ä¸ªå”®ç¥¨å¤„åŒæ—¶è¿›è¡Œå–ç¥¨å¹¶ä¸”æ˜¯ä»¥åˆä½œè€Œéç«äº‰çš„æ–¹å¼åŒæ—¶é”€å”®æ€»å…±çš„150å¼ ç¥¨ã€‚

è€Œä¸”æ¯ä¸ªå”®ç¥¨å¤„å–ç¥¨çš„æ•°é‡ä¹Ÿä¸èƒ½åªæ˜¯ç®€å•çš„numTickets/numAgentsï¼Œè™½ç„¶è¿™æ ·æ‰€æœ‰çš„150å¼ ç¥¨éƒ½ä¼šè¢«å–æ‰ï¼Œä½†æ˜¯ï¼Œä½†æˆ‘ä»¬è¿™æ ·åšæ˜¯é¡ºåºæ‰§è¡Œçš„ï¼š1->2->3....->10

æˆ‘ä»¬éœ€è¦å»ºç«‹çš„æ¨¡å‹æ˜¯è¿™æ ·çš„ï¼š

æ‰€æœ‰çš„agentéµç…§åŒæ ·çš„å‡½æ•°ï¼ŒæŒ‰ç…§ç›¸åŒçš„æ­¥éª¤æ¥é”€å”®è¿™äº›ç¥¨ï¼Œä½†æ˜¯å®ƒä»¬çœ‹èµ·æ¥åº”è¯¥æ˜¯åŒæ—¶è¿è¡Œç€ï¼Œè€Œä¸æ˜¯æŒ‰ç…§å›ºå®šçš„é¡ºåºã€‚

### 2 â€œçœ‹èµ·æ¥åŒæ—¶è¿›è¡Œâ€çš„æ¨¡æ‹Ÿç¨‹åº

æˆ‘ä»¬éœ€è¦ä½¿ç”¨çº¿ç¨‹åº“ï¼Œåœ¨C å’Œ C++ æ ‡å‡†ä¸­ï¼Œçº¿ç¨‹åŒ…å’Œåº“æ¥æ”¯æŒæˆ‘ä»¬åœ¨è¿™é‡Œæ‰€åšçš„ã€‚

è¿™15ä¸ªticket agent æ¯ä¸ªéƒ½çœ‹èµ·æ¥åƒæ˜¯è·‘é“ä¸Šçš„ç‹—ä¸€æ ·ï¼Œæˆ‘ä»¬è¦åšçš„äº‹æŠŠé—¨æ‰“å¼€ï¼Œå®ƒä»¬ä¹‹é—´ä¸ä¼šç›¸äº’ç«äº‰ã€‚å¹¶ä¸”å®ƒä»¬ä¼šåˆ°è¾¾ç»ˆç‚¹ã€‚æ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¼šéµå¾ªè¿™ä¸ªè§„åˆ™ã€‚å½“å®ƒä»¬å…¨éƒ¨å®Œæˆçš„æ—¶å€™ï¼Œæ‰€æœ‰çš„å·¥ä½œä¹Ÿå°†å®Œæˆã€‚

```c
void sellTickets(int agentid, int numTicketsToSell)
{
    while(numTicketsToSell > 0)
    {
        printf("Agent%d sells a ticket\n", agentNo);
        numTicketsToSell--;
    }
    
    printf("Agent%d: All done!\n", agentNo);
}


int main()
{
    int numAgents = 10; 
    int numTickets = 150; 
    
 
    InitThreadPackage(false);       // cs107 package ä¸­çš„çº¿ç¨‹åº“å‡½æ•° false è¡¨ç¤ºä¸æ‰“å°debug info
    
    for(int agent = 1; agent <= numAgents; agent++)
    {
        char name[32];      // åŒºåˆ†ä¸åŒçš„çº¿ç¨‹
        sprintf(name, "Agent %d Thread", agent);
        ThreadNew(name, sellTickets, 2, agent, numTickets/numAgent);        // åˆ›å»ºçº¿ç¨‹ï¼Œæ‰€æœ‰çš„ç‹—ç«™åœ¨äº†èµ·è·‘çº¿ä¸Š
        if(RandomChance(0.1))
        {
            ThreadSleep(1000);  // æš‚åœä½¿ç”¨å¤„ç†å™¨è‡³å°‘1s
        }
    }
    RunAllThreads();    // release the dogï¼Œ è®©ç‹—å­ä»¬è·‘èµ·æ¥ block å‡½æ•°ï¼Œå½“æ‰€æœ‰çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åè¿”å›
  
    return 0; // returns 0 to satisfied compiler 
}
```

Q&A:

1. åœ¨è¿™ä¸ªä¾‹å­ä¸­ThreadInit, ThreadNew éƒ½æ”¾åœ¨main å‡½æ•°ä¸­æ‰§è¡Œæ›´æ–¹ä¾¿äº›
2. äº‹å®ä¸Šåœ¨è¿è¡Œçº¿ç¨‹ä¹‹å‰ï¼Œå¿…é¡»å…ˆæ‰§è¡ŒInitPackageï¼Œå¹¶è®¾ç½®å¥½æ‰€æœ‰çš„çº¿ç¨‹ã€‚æ— è®ºæ˜¯åœ¨main ä¸­è¿˜æ˜¯é€šè¿‡å­å‡½æ•° RunAllThreads å®é™…ä¸Šèµ·åˆ°å¼•å¯¼çº¿ç¨‹æ‰§è¡Œçš„ä½œç”¨ã€‚
3. çº¿ç¨‹è‡ªå·±ä¹Ÿå¯ä»¥åˆ›å»ºçº¿ç¨‹ï¼Œ(spawn their own child threads) æœ‰äº›è’è°¬çš„æ¯”å–»æ˜¯ä¸€åªç‹—å­åœ¨èµ›è·‘ä¸­ç„¶åç”Ÿä¸‹ä¸‰åªå°ç‹—å­ï¼Œç„¶åæŠŠä¸‰åªå°ç‹—æŠ›åˆ°èµ·è·‘çº¿ç„¶åå¯¹ä»–ä»¬è¯´â€œPlease runâ€ã€‚ğŸ˜‚ è¿™ç±»äº‹ä»¶ä¼šäº§ç”Ÿä¸€äº›å¾ˆæœ‰è¶£çš„å¹¶å‘æ€§é”™è¯¯ã€‚

### è°ƒåº¦ï¼šæ—¶é—´ç‰‡åˆ†é…

> è¿è¡Œæ‰€æœ‰çš„çº¿ç¨‹ï¼Œä¼šè®©ä½ æœ‰å¿ƒè·³çš„æ„Ÿè§‰ï¼Œæ¯æ¬¡boom ä¹‹é—´éƒ½æ˜¯åœ¨æ‰§è¡Œä¸åŒçš„å‡½æ•°ï¼Œä¸”å®ƒä»¬é€šå¸¸é€šè¿‡å¾ªç¯è°ƒåº¦[Round-Robin]çš„æ–¹å¼æ¥è·å–ä¸¤æ¬¡å¿ƒè·³ä¹‹é—´çš„æ—¶é—´ç‰‡(time slice)ã€‚

æ¯ä¸ªagents åœ¨è‡ªå·±çš„æ—¶é—´ç‰‡é‡Œå–ç¥¨ã€‚å‡å¦‚ä¸åŠ å…¥éšæœºåŒ–æ–¹æ³•ï¼Œé‚£å°±å’Œç°å®ç”Ÿæ´»ä¸­çš„ç³»ç»Ÿæ‰§è¡Œå®Œå…¨ç›¸åŒæˆ–è€…éå¸¸æ¥è¿‘ã€‚æ¯ä¸ªäººåœ¨è‡ªå·±çš„æ—¶é—´ç‰‡ä¸­å‡ ä¹å¯ä»¥å–å‡ºç›¸åŒæ•°é‡çš„ç¥¨ã€‚ä¸ºäº†æ›´æ¥è¿‘ç°å®åœºæ™¯ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå¼•å…¥ä¸€äº›éšæœºåŒ–çš„è¿‡ç¨‹ã€‚

Qï¼šå“ªä¸ªçº¿ç¨‹åœ¨å–ç¥¨ï¼Ÿ

A:  çœŸæ­£è°ƒç”¨å–ç¥¨çš„çº¿ç¨‹ï¼ŒThreadSleep åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ã€‚ä½†æ˜¯ä¸€å…±æœ‰10ä¸ªçº¿ç¨‹åœ¨ç­‰å€™æ‰§è¡Œè¿™æ®µä»£ç ï¼Œå®ƒä»¬å„è‡ªæœ‰è‡ªå·±çš„æŒ‡é’ˆæŒ‡å‘è¿™æ®µç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç ã€‚å‡å¦‚æœ‰ä¸€ä¸ªçº¿ç¨‹åˆšå¥½è¿›å…¥äº†ThreadSleepï¼Œå…¶å®å°±æ˜¯é™·å…¥äº†è¿™æ®µä»£ç ä¸­ï¼Œç„¶åè¢«å¤„ç†å™¨æš‚åœè¿è¡Œã€‚ç”šè‡³ä»Ready Queue ä¸­è¢«æ¨å‡ºï¼Œæ”¾å…¥åˆ°Block Queueä¸­ï¼Œç›´åˆ°æŒ‡å®šçš„æ—¶é—´è¿‡å»ã€‚

Q: æ‰€æœ‰çš„çº¿ç¨‹éƒ½æ˜¯è¿™æ ·æ‰§è¡Œå—ï¼Ÿ æœ‰æ²¡æœ‰ä¸€ç§æœºåˆ¶æ¥æ§åˆ¶æ¯ä¸ªçº¿ç¨‹åº”è¯¥æ‰§è¡Œå¤šå°‘ä¸ªå¾ªç¯ï¼Ÿ

A: cs107ä¸­ä½¿ç”¨çš„çº¿ç¨‹åº“ä¸æ”¯æŒï¼Œå¤šæ•°çº¿ç¨‹åº“ä¸ä¼šæä¾›æ—¶é—´ç‰‡æŒç»­æ—¶é—´çš„æ§åˆ¶æƒï¼Œè¿™æ ·ä¼šäº§ç”Ÿä¸å¯é¢„è§çš„ç»“æœï¼Œæ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œäº†å¾ˆé•¿æ—¶é—´ä»¥è‡³äºå…¶ä»–çº¿ç¨‹æ— æ³•è·å¾—æ—¶é—´ç‰‡ã€‚ä½†æ˜¯javaä¸Šçš„ä¸€äº›çº¿ç¨‹åº“å¯ä»¥é™„åŠ ä¼˜å…ˆçº§ï¼Œé€šå¸¸ä¼šå¯¹çº¿ç¨‹çš„ä¼˜å…ˆçº§è¿›è¡Œæ’åºï¼Œåœ¨ä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹æ‰§è¡Œå®Œæˆä¹‹å‰ï¼Œä¼˜å…ˆçº§ä½çš„çº¿ç¨‹å°†ä¸ä¼šæœ‰ä»»ä½•åŠ¨ä½œã€‚ä½†æ˜¯æˆ‘ä»¬ç°åœ¨æ²¡æœ‰ï¼Œåªéœ€è€ƒè™‘æ‰€æœ‰çº¿ç¨‹ä¼˜å…ˆçº§å¹³ç­‰çš„è¿™ç§æƒ…å†µã€‚çº¿ç¨‹è¢«è½®æµè°ƒåº¦å¹³ç­‰åœ°å ç”¨å¤„ç†å™¨ä¸€æ®µæ—¶é—´ï¼Œé™¤éæœ‰å…¶ä»–çš„äº‹ä»¶é˜»å¡äº†çº¿ç¨‹çš„è¿è¡Œã€‚

æŒ‰ç…§ä¸Šé¢çš„ä»£ç ï¼Œæ‰“å°çš„è¾“å‡ºä¼šæ˜¯æ€æ ·å‘¢ï¼Ÿ

ä½ å¯èƒ½ä¼šå…ˆå¾—åˆ°3æ¡printfçš„è¾“å‡º

```shell
Agent 1 sells a ticket
...

Agent 2 sells a ticket 
Agent 3 sells a ticket
[5times]

....
Agent 7 All done! 
Agent 8 sells a ticket 
Agent 8 All done! 
...
Agent 3 All done!
```

Q: å¦‚æœæ²¡æœ‰ä½¿ç”¨çº¿ç¨‹æœºåˆ¶

A: çº¿ç¨‹æœºåˆ¶å¯¹äºwhileå¾ªç¯æ²¡æœ‰ä»»ä½•çš„æ¦‚å¿µï¼Œå®ƒä¸ä¼šæ£€æµ‹åˆ°å¾ªç¯è·³è½¬ï¼Œå¹¶æŠŠè¿™ç§è·³è½¬ä½œä¸ºæš‚åœçº¿ç¨‹å ç”¨å¤„ç†å™¨çš„ä¿¡å·ï¼Œå…¸å‹çš„æ—¶é—´ç‰‡é•¿åº¦æ˜¯100msï¼Œä½†æ˜¯åœ¨ä¸€ä¸ªå…¸å‹çš„æ—¶é—´ç‰‡ä¸­å¾ˆå¤šç¥¨å¯è¢«å”®å‡ºï¼Œå¦‚æœæ‰“å°æ¥å¾—åŠçš„è¯ã€‚æœ‰æ—¶å€™ä½ ä¼šæ‰§è¡Œåˆ°ä¸€åŠï¼Œä¹Ÿè®¸ä½ æ­£åœ¨æ‰§è¡Œprintfï¼Œç„¶åä½ å¤±å»äº†å¤„ç†å™¨èµ„æºï¼Œå½“çº¿ç¨‹é‡æ–°è·å¾—æ—¶é—´ç‰‡çš„æ—¶å€™ï¼Œæ¥ç€æ‰§è¡Œprintfç›´åˆ°å®Œæˆï¼Œè¿”å›å¹¶å°†ç¥¨çš„æ€»æ•°å‡å°‘ã€‚

Q:

A: æœ‰äº›çº¿ç¨‹åŒ…å…è®¸æ§åˆ¶æ—¶é—´ç‰‡ï¼Œä½†é€šå¸¸æ²¡æœ‰é‚£ä¹ˆé«˜çš„ä¼˜å…ˆçº§ã€‚é€šå¸¸ä½ ä¸å¿…åœ¨ç¨‹åºä¸­é€šè¿‡çº¿ç¨‹æ¥æ§åˆ¶æ—¶é—´ç‰‡çš„è½®è½¬ã€‚ä½ åªéœ€è¦ä½¿ç”¨å¹¶å‘ç¼–ç¨‹å°±å¯ä»¥äº†ã€‚ è®©çº¿ç¨‹ç®¡ç†å™¨æ¥å†³å®šå“ªä¸ªçº¿ç¨‹ä¼˜å…ˆçº§æœ€é«˜ã€‚å®é™…ç”Ÿæ´»ä¸­å¦‚æœagent2 - agent10é•¿æœŸè¢«å ç”¨çš„æ—¶å€™ï¼ˆä¸€ç›´æœ‰äººåœ¨æ‰“ç”µè¯ï¼Œå çº¿ï¼‰æˆ‘ä»¬ä¹Ÿå¹¶ä¸æƒ³æŠŠagent1ä»Ready Queueä¸­ç§»å‡ºã€‚ä»£ç ä¸­çš„é€»è¾‘ä¹Ÿæ˜¯ã€‚ä½†æ˜¯åœ¨æ¨¡æ‹Ÿä¸­ï¼Œå½“å…¶ä»–agentéƒ½è¢«é˜»å¡çš„æ—¶å€™ï¼Œä½ ä¼šè®©agent1 ä¿æŒå”®ç¥¨çŠ¶æ€ã€‚

Qï¼šThreadSleep è®©çº¿ç¨‹ä»è¿è¡ŒçŠ¶æ€å˜æˆé˜»å¡çŠ¶æ€ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åæ”¾åˆ°Ready Queue ç­‰å¾…ç»§ç»­è¿è¡Œã€‚

Aï¼š ThreadSleepä»£ç æ˜¯è¢«10ä¸ªä¸åŒçš„çº¿ç¨‹è°ƒç”¨çš„ã€‚ä»£ç æœ¬èº«åªæœ‰ä¸€ä»½ã€‚

Qï¼šçº¿ç¨‹åˆå§‹åŒ–ä¹‹åç›´æ¥å°±è¿è¡Œå—ï¼Ÿ

Aï¼šå…ˆåˆå§‹åŒ–çº¿ç¨‹åŒ…ï¼Œç„¶ååˆ›å»ºè‡³å°‘ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¥è¿è¡Œä»¥ç¡®ä¿æ‰€æœ‰éœ€è¦åšçš„å·¥ä½œå·²ç»å…¨éƒ¨å°±ç»ªï¼Œå¹¶ä¸”æ˜¯ä»¥å¹¶è¡Œè€Œä¸æ˜¯ä¸²è¡Œçš„æ–¹å¼ã€‚ç„¶åè°ƒç”¨RunAllThreads() æ¥è®©æ‰€æœ‰çº¿ç¨‹å¼€å§‹è¿è¡Œã€‚

Q:

A: main threads ä¹Ÿæ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œå› æ­¤ä½œä¸ºä¸²è¡Œæ‰§è¡Œçš„ä¸€éƒ¨åˆ†ï¼ˆå®ƒå…¶å®ä¸æ˜¯ä¸²è¡Œçš„ï¼Œå› ä¸ºå®ƒç¢°å·§ä»ç„¶åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œè€Œè¿™ä¸ªçº¿ç¨‹æ°å·§æ˜¯main threadï¼Œè€Œä¸æ˜¯å­çº¿ç¨‹ä¸­çš„ä¸€ä¸ªï¼‰ï¼Œå­çº¿ç¨‹æ˜¯ç”±main çº¿ç¨‹äº§ç”Ÿçš„ã€‚

Q:çº¿ç¨‹å¹¶ä¸çŸ¥é“å®ƒæ˜¯å¦åœ¨while loopä¸­ï¼Œé‚£ä¹ˆå®ƒæ˜¯å¦çŸ¥é“å®ƒåœ¨æ‰§è¡ŒæŸæ¡æŒ‡ä»¤ä¸­ï¼Ÿ

A:è¿™æ˜¯ä»Šå¤©è¯¾ç¨‹æœ€æœ‰è¶£çš„éƒ¨åˆ†ã€‚å¯¹äºä»£ç ç”Ÿæˆæˆ‘ä»¬å·²ç»æœ‰äº†è¶³å¤Ÿçš„äº†è§£ã€‚`numTicketsToSell--;` è¿™æ¡æŒ‡ä»¤å¹¶ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œã€‚å®ƒçœ‹èµ·æ¥åƒæ˜¯ä¸€ä¸ªåŸå­æ“ä½œã€‚ä½†æ˜¯å®é™…ä¸Šæ˜¯å¯¹å±€éƒ¨å˜é‡çš„ä¿®æ”¹ï¼Œå¯¹åº”ä¸‰æ¡æ±‡ç¼–è¯­å¥çš„è¡¨ç¤º load-alu-store. çº¿ç¨‹å¹¶ä¸çŸ¥é“æ‰§è¡Œçš„æ±‡ç¼–ä»£ç å…·ä½“æ˜¯åšä»€ä¹ˆçš„ï¼Œcä»£ç å¹¶ä¸æ˜¯åŸå­æ€§çš„ã€‚å› æ­¤å½“çº¿ç¨‹å¤±å»å¤„ç†å™¨ä½¿ç”¨æƒæ—¶ï¼Œå®ƒå¯èƒ½æ­£å¥½å¤„äºè¿™ä¸‰æ¡è¯­å¥æ‰§è¡Œä¹‹å‰ï¼Œæ‰§è¡Œä¹‹åï¼Œä¹Ÿæœ‰å¯èƒ½æ­£åœ¨æ‰§è¡Œç€ä¸‰æ¡æ±‡ç¼–è¯­å¥ä¸­çš„æŸä¸€æ¡ã€‚

### åŸå­æ“ä½œ

> åŸå­(atomic)æœ¬æ„æ˜¯"ä¸èƒ½è¢«è¿›ä¸€æ­¥åˆ†å‰²çš„æœ€å°ç²’å­"ï¼Œè€ŒåŸå­æ“ä½œ(atomic operation)æ„ä¸º"ä¸å¯ä¸­æ–­çš„ä¸€ä¸ªæˆ–ä¸€ç³»åˆ—æ“ä½œ"ã€‚è¦ä¹ˆå®Œå…¨è¢«æ‰§è¡Œï¼Œè¦ä¹ˆå°±å›æ»šï¼Œä¸€ç‚¹ä¹Ÿä¸æ‰§è¡Œã€‚

~~çº¿ç¨‹å¯èƒ½åœ¨åš--æ“ä½œæ—¶å¤±å»äº†å¤„ç†å™¨çš„ä½¿ç”¨æƒï¼Œç­‰å®ƒåæ¥é‡æ–°å ç”¨å¤„ç†å™¨çš„æ—¶å€™~~

çº¿ç¨‹åº“åœ¨çº¿ç¨‹é—´æœç´¢ï¼Œè¿™ä¸ªåŠ¨ä½œç”±ä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹è¿›è¡Œï¼Œå®ƒæ€»æ˜¯èƒ½é‡æ–°è·å¾—å¤„ç†å™¨çš„ä½¿ç”¨æƒï¼Œåœ¨æ¯ä¸ªæ—¶é—´ç‰‡çš„æœ«ç«¯.

Example:

â€‹ç”Ÿæˆ12ä¸ªä¸‹è½½çº¿ç¨‹ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½å»ç­‰å¾…é“¾æ¥å¹¶ä¸”ä¸‹è½½ï¼Œç”±äºåœ¨å†…æ ¸çº§åˆ«ä¸­æœ‰é˜»å¡æœºåˆ¶ï¼Œçº¿ç¨‹ä¼šå¤±å»å¯¹å¤„ç†å™¨çš„æ§åˆ¶ï¼Œè¿™æ˜¯æ›´åŠ å‰å®³çš„çº¿ç¨‹ä¼‘çœ ã€‚ä½†æ˜¯è¿™é‡Œçš„ä¼‘çœ æ˜¯æœ‰åˆç†çš„ç†ç”±çš„ã€‚å› ä¸ºçº¿ç¨‹å’Œçº¿ç¨‹ç®¡ç†å™¨éƒ½çŸ¥é“å®ƒå¯ä»¥æ›´å¥½çš„è¿è¡Œï¼Œæ‰€ä»¥å½“çº¿ç¨‹ç­‰å¾…è¿æ¥æ—¶ï¼Œå®ƒå°±ä¼šå¤±å»å¯¹å¤„ç†å™¨çš„æ§åˆ¶æƒã€‚å‡è®¾12ä¸ªçº¿ç¨‹ç»“æŸçš„æ—¶é—´éƒ½å’Œç½‘ç»œè¿æ¥æœ‰å…³ã€‚å®ƒä»¬éƒ½æ’å¥½é˜Ÿä»¥è¿™ç§æ–¹å¼ä¾æ¬¡è¿›å…¥ç®¡é“ä¸­ï¼Œè¿™æ ·ä¼šèŠ‚çœæˆ‘ä»¬å¾ˆå¤šçš„æ—¶é—´ã€ç­‰å¾…ç½‘ç»œé“¾æ¥ã€‘ã€‚

### 3. agent å»è®¿é—®å…±äº«çš„å‰©ä½™ç¥¨æ•°é‡

æ¯ä¸ªå”®ç¥¨ç‚¹ä¸ä¼šæŒ‰ç…§é¢„å…ˆè®¾å®šå¥½çš„æ•°é‡å–ç¥¨ï¼Œè€Œæ˜¯è·å–å½“å‰å‰©ä½™ç¥¨å¹¶è¿›è¡Œå”®å–ã€‚

è®©è¿™äº›agentè®¿é—®åŒä¸€ä¸ªå…±äº«çš„æ•´æ•°

```c
void sellTickets(int agent, int* numTicketsp)
{
    /* critical region */
    while(*numTicketsp > 0)
    {
        *(numTicketsp)--;
    } 
    /* critical region */
    
}


int main()
{
    int numAgents = 10; 
    int numTickets = 150; 
    
 
    InitThreadPackage(false);       // cs107 package ä¸­çš„çº¿ç¨‹åº“å‡½æ•° false è¡¨ç¤ºä¸æ‰“å°debug info
    
    for(int agent = 1; agent <= numAgents; agent++)
    {
        char name[32];  // åŒºåˆ†ä¸åŒçš„çº¿ç¨‹
        sprintf(name, "Agent %d Thread", agent);
        ThreadNew(name, sellTickets, 2, agent, &numTickets);    // åˆ›å»ºçº¿ç¨‹ï¼Œæ‰€æœ‰çš„ç‹—ç«™åœ¨äº†èµ·è·‘çº¿ä¸Š
        if(RandomChance(0.1))
        {
            ThreadSleep(1000);  // æš‚åœä½¿ç”¨å¤„ç†å™¨è‡³å°‘1s
        }
    }
    RunAllThreads();    // release the dogï¼Œ è®©ç‹—å­ä»¬è·‘èµ·æ¥ block å‡½æ•°ï¼Œå½“æ‰€æœ‰çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åè¿”å›
  
    return 0; // returns 0 to satisfied compiler 
}
```

æ‰€æœ‰çš„çº¿ç¨‹éƒ½æ‹¥æœ‰ä¸€ä¸ªæŒ‡é’ˆnumTicketsp æŒ‡å‘numTickets å˜é‡ï¼Œåˆå§‹å€¼æ˜¯150

![image-20220531165224844](Lec 15.assets/image-20220531165224844.png)

å‡è®¾è¿™æ ·ä¸€ç§æƒ…å†µï¼Œ

1. agent1 çœ‹åˆ°è¿˜å‰©ä¸‹äº†ä¸€å¼ ç¥¨ï¼Œç„¶åè¿›è¡Œå–ç¥¨ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ¥å¾—åŠå¯¹è¿™ä¸ªçº¿ç¨‹é—´å…±äº«çš„å˜é‡å®Œæˆå‡1çš„æ“ä½œæ—¶å°±è€—å°½äº†æ—¶é—´ç‰‡
2. Agent2 çœ‹åˆ°è¿˜å‰©ä¸‹ä¸€å¼ ç¥¨ï¼Œå¹¶æ‰§è¡Œäº†åŒæ ·çš„æ“ä½œï¼Œäºæ˜¯å®ƒè¯•å›¾å¯¹å…±äº«çš„å˜é‡è¿›è¡Œå‡1 çš„æ“ä½œã€‚ä½†æ˜¯ä¹Ÿæ²¡æ¥å¾—åŠå®Œæˆå°±è€—å°½äº†æ—¶é—´ç‰‡ã€‚
3. ç›¸ä¼¼çš„äº‹æƒ…ä¹Ÿå¯èƒ½å‘ç”Ÿåœ¨å…¶ä»–çš„çº¿ç¨‹ä¸­ã€‚
4. å½“æ¯ä¸ªäººéƒ½è¯•å›¾å–æ‰æœ€åä¸€å¼ ç¥¨çš„æ—¶å€™ï¼Œè¿™ç®€ç›´å¤ªå¯æ€•äº†ã€‚
5. å½“çº¿ç¨‹é‡æ–°è·å¾—æ—¶é—´ç‰‡è¿è¡Œæ—¶ï¼Œå®ƒä»¬ä¸ä¼šé‡æ–°æ£€æŸ¥ä¹‹å‰æ‰§è¡Œçš„è¿‡ç¨‹ã€‚æ‰€ä»¥ä»–ä»¬éƒ½è¯•å›¾å‡å°‘è¿™ä¸ªå…±äº«çš„å…¨å±€å˜é‡ã€‚è¿™æ ·è¿™ä¸ªå˜é‡å°±å¯èƒ½ä¼šå˜æˆ-9ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„å¹¶å‘å¯¼è‡´çš„é—®é¢˜ã€‚

### threads are sharing resource

å®ƒä»¬éƒ½ä¾èµ–äºå…±äº«çš„ å†…å­˜æ•°æ®ï¼Œå¦‚æœå®ƒä»¬ä¸æ³¨æ„æ“ä½œè¿™äº›æ•°æ®çš„æ–¹å¼ï¼Œåœ¨æ‰§è¡Œæ“ä½œçš„è¿‡ç¨‹ä¸­ä¸­é€”é€€å‡ºï¼Œå¹¶ä¸”çº¿ç¨‹è¦æ ¹æ®è¿™ä¸ªå…±äº«æ•°æ®è¿›è¡Œåˆ¤æ–­ï¼Œè¿™æ ·å½“å®ƒå¤±å»å¤„ç†å™¨çš„æ§åˆ¶æƒæ—¶ï¼Œå…¨å±€æ•°æ®çš„å®Œæ•´æ€§å°±è¢«ç ´åäº†

### critical region

å½“è¿›å…¥è¿™ä¸ªåŒºåŸŸå¹¶ä¸”å¯¹çº¿ç¨‹å…±äº«çš„èµ„æºæ‰§è¡Œæ“ä½œæ—¶ï¼Œæ²¡æœ‰å…¶ä»–çº¿ç¨‹èƒ½å¤Ÿè¿›å…¥åˆ°è¿™ä¸ªåŒºåŸŸ
åœ¨æœ¬æ®µä»£ç ä¸­å¹¶æ²¡æœ‰è¯­å¥è¡¨æ˜ å‘ŠçŸ¥å…¶å®ƒçº¿ç¨‹â€œæˆ‘åœ¨critical region ä¸­ï¼Œä½ ä»¬ä¸å¯è¿›å…¥â€ï¼Œæ‰€ä»¥å¿…é¡»æœ‰ä¸€äº›è¯­å¥æ”¾åˆ°critical region çš„ä½ç½®ä»¥ä¾¿é˜»å¡å…¶å®ƒçº¿ç¨‹ï¼Œä»¥åŠæ‰§è¡Œå‡ºcritical region æ—¶è§£é™¤å¯¹å…¶å®ƒçº¿ç¨‹çš„é˜»å¡ã€‚
åœ¨ä»»ä½•æ—¶å€™æˆ‘ä»¬éƒ½å¸Œæœ›åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨critical regionä¸­

### 4. ä½¿ç”¨Semaphoreé™åˆ¶å¯¹ä¸´ç•ŒåŒºåŸŸçš„è®¿é—®

ä¿¡å·é‡:

åœ¨ç¼–ç¨‹ä¸­semaphoreä½œä¸ºä¸€ä¸ªéè´Ÿæ•´æ•°å‘æŒ¥ä½œç”¨ã€‚å®ƒæ”¯æŒâ•1å’Œâ–1åŸå­æ“ä½œåŠŸèƒ½ã€‚

â€‹ä¸å…è®¸ä¿¡å·é‡ç»´æŠ¤çš„å€¼ç¼–ç¨‹è´Ÿæ•°ï¼Œå¦‚æœSemaphoreWait å‘ç°ä¿¡å·é‡ä¸º0, å®ƒä¸ä¼šæŠŠä¿¡å·é‡å˜æˆ-1 å®ƒä¼šæ‰§è¡Œ"block"åŠ¨ä½œï¼ŒæŠŠä¿¡å·é‡é˜»å¡èµ·æ¥ï¼Œè¿™æ—¶ä»–å°±ä¼šæš‚åœå ç”¨å¤„ç†å™¨èµ„æºã€‚æ˜¾ç„¶ï¼Œå®ƒçŸ¥é“è‡ªèº«å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå¹¶ä¸”ä¸€ç›´ç­‰åˆ°å…¶å®ƒçº¿ç¨‹åšäº†SemaphoreSignal åŠ¨ä½œã€‚

```c
SemaphoreWait(lock);    // -1
SemaphoreSignal(lock);  // +1 
```

å®ƒä»¬åªæ˜¯åˆ©ç”¨ç¡¬ä»¶æˆ–è€…æ±‡ç¼–æŒ‡ä»¤æ”¹å˜ç»´æŠ¤çš„æ•´æ•°çš„å€¼

```c
void sellTickets(int agent, int* numTicketsp, Semaphore lock)
{
    while(true) // ä¸èƒ½å†åœ¨whileä¸­åšåˆ¤æ–­äº†ï¼Œå› ä¸ºéšç€å¤„ç†çš„æ·±å…¥ï¼Œæˆ‘ä»¬ä¸èƒ½ä¿è¯æ­¤å¤„åˆ¤æ–­çš„ç»“æœæ­£ç¡®æ€§
    {
        SemaphoreWait(lock);
        if(*numTicketsp  == 0) break; 
        
        (*numTicketsp)--;
        printf("--------\n");
        SemaphoreSignal(lock);
    }
    SemaphoreSignal(lock);  // å¯¹åº”break
    
}

/*
    åœ¨å¾ªç¯ä¸­ä¸åœçš„lock unlock, å¹¶ä¸”å¯èƒ½åœ¨å¯¹å…±äº«èµ„æºæ“ä½œæ—¶å¤±å»å¯¹å¤„ç†å™¨çš„ä½¿ç”¨æƒï¼Œè¿™æ ·æ˜¯å¾ˆå±é™©çš„ï¼Œé™¤éæœ‰ä¿¡å·é‡ä¸º0ä¿è¯å…¶ä»–çº¿ç¨‹æ— æ³•å¯¹å…±äº«èµ„æºè¿›è¡Œæ“ä½œã€‚å› ä¸ºæ­¤æ—¶å…¶ä»–çº¿ç¨‹è¢«é˜»å¡åœ¨critical region ä¹‹å‰æ— æ³•å‰è¿›ã€‚

*/


int main()
{
    int numAgents = 10; 
    int numTickets = 150; 
    
    Semaphore lock = SemaphoreNew( , 1); // ä¿¡å·é‡ï¼Œåˆå§‹å€¼ä¸º1
    
    InitThreadPackage(false);   // cs107 package ä¸­çš„çº¿ç¨‹åº“å‡½æ•° false è¡¨ç¤ºä¸æ‰“å°debug info
    
    for(int agent = 1; agent <= numAgents; agent++)
    {
        char name[32];  // åŒºåˆ†ä¸åŒçš„çº¿ç¨‹
        sprintf(name, "Agent %d Thread", agent);
        ThreadNew(name, sellTickets, 3, agent, &numTicketsï¼Œ lock);// åŠ ä¸€ä¸ªå‚æ•°ï¼Œå°†lock ä¼ ç»™çº¿ç¨‹
        if(RandomChance(0.1))
        {
            ThreadSleep(1000);	// æš‚åœä½¿ç”¨å¤„ç†å™¨è‡³å°‘1s
        }
    }
    RunAllThreads();    // release the dogï¼Œ è®©ç‹—å­ä»¬è·‘èµ·æ¥ block å‡½æ•°ï¼Œå½“æ‰€æœ‰çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åè¿”å›
  
    return 0; // returns 0 to satisfied compiler 
}
```

å¦‚æœåœ¨æ‰§è¡Œçš„ä»»ä½•ä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œè¯¥çº¿ç¨‹å¤±å»äº†å¤„ç†å™¨èµ„æºã€‚å…¶ä»–çº¿ç¨‹æ“ä½œäº†å…±äº«å˜é‡ï¼Œé‚£whileï¼ˆï¼‰ä¹‹åçš„è¯­å¥å°±æ²¡æœ‰æ„ä¹‰äº†ã€‚

ä¿¡å·é‡çš„åˆå§‹å€¼ä¸º1 æ„å‘³ç€èµ„æºåªèƒ½ä¿è¯æœ€å¤š1ä¸ªçº¿ç¨‹æ¥ä½¿ç”¨ã€‚

### æ­»é”

å¦‚æœåˆå§‹å€¼è®¾ç½®ä¸º0ï¼Œé‚£å°±æ„å‘³ç€æ‰€æœ‰çš„äººéƒ½ä¼šè¢«é˜»å¡ã€‚æ‰€æœ‰çº¿ç¨‹èµ°åˆ°critical region ä¹‹å‰éƒ½ä¼šè®¤ä¸ºæœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨ä½¿ç”¨å…±äº«èµ„æºï¼Œç„¶åæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šå¤„äºç­‰å¾…çŠ¶æ€ã€‚

å¦‚æœå°†ä¿¡å·é‡çš„å€¼è®¾ç½®ä¸º2ï¼Œé‚£å°±æ„å‘³ç€å…è®¸æœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥critical regionï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹ä¼šæä¹±å…¨å±€æ•°æ®

Q&A ä¸ºä»€ä¹ˆä¼šæœ‰ä¸¤ä¸ªSemaphoreSignal?

æœ€åä¸€ä¸ªSemaphoreSignal å¯¹åº”ä»£ç ä¸­çš„break åæ‰§è¡Œçš„æ“ä½œã€‚

Q&A æœ‰æ²¡æœ‰æ¯”ä¿¡å·é‡æ›´åŠ å¼ºå¤§çš„æ–¹æ³•ï¼Œè®©çº¿ç¨‹ä¸ä¼šåœ¨æ•æ„Ÿçš„èŠ‚ç‚¹å¤±å»å¯¹å¤„ç†å™¨çš„å ç”¨ï¼Ÿ

å®é™…ä¸Šä¼˜å…ˆçº§å°±å¯ä»¥ã€‚ç€åº”è¯¥æ˜¯çº¿ç¨‹ç®¡ç†å™¨çš„ä»»åŠ¡ã€‚å¦‚æœåªæœ‰ä¸€ä¸ªä¼˜å…ˆçº§å¾ˆé«˜çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆå°±ä¼šä¸€ç›´è®©å®ƒè¿è¡Œç›´åˆ°å®ƒé˜»å¡ã€‚